# ç¶™ç¶šçš„ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆï¼ˆCDï¼‰ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# mainãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥æ™‚ã«ãƒªãƒªãƒ¼ã‚¹å‡¦ç†ã‚’å®Ÿè¡Œ
name: CD

on:
    push:
        branches:
            - main

jobs:
    publish:
        runs-on: ubuntu-latest
        steps:
            # ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
            - name: Checkout code
              uses: actions/checkout@v4

            # Node.jsã®ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆnpm viewç”¨ï¼‰
            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  registry-url: "https://registry.npmjs.org"

            # ãƒãƒ¼ã‚¸ãƒ§ãƒ³å¤‰æ›´ãƒã‚§ãƒƒã‚¯ï¼ˆnpmã«å…¬é–‹æ¸ˆã¿ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨æ¯”è¼ƒï¼‰
            - name: Check if version changed
              id: version-check
              run: |
                  CURRENT_VERSION=$(node -p "require('./package.json').version")
                  PUBLISHED_VERSION=$(npm view discord-interface-mcp version 2>/dev/null || echo "0.0.0")
                  echo "Current version: $CURRENT_VERSION"
                  echo "Published version: $PUBLISHED_VERSION"
                  echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
                  echo "previous_version=$PUBLISHED_VERSION" >> $GITHUB_OUTPUT
                  if [ "$CURRENT_VERSION" != "$PUBLISHED_VERSION" ]; then
                    echo "should_publish=true" >> $GITHUB_OUTPUT
                    echo "Version changed, will publish"
                  else
                    echo "should_publish=false" >> $GITHUB_OUTPUT
                    echo "Version unchanged, skipping publish"
                  fi

            # Bunã®ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
            - name: Setup Bun
              if: steps.version-check.outputs.should_publish == 'true'
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest

            # ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
            - name: Install dependencies
              if: steps.version-check.outputs.should_publish == 'true'
              run: bun install

            # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ
            - name: Build
              if: steps.version-check.outputs.should_publish == 'true'
              run: bun run build

            # npmã¸ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å…¬é–‹
            - name: Publish to npm
              if: steps.version-check.outputs.should_publish == 'true'
              run: npm publish --access public
              env:
                  NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

            # Gitãƒªãƒªãƒ¼ã‚¹ã‚¿ã‚°ã®ä½œæˆ
            - name: Create release tag
              if: steps.version-check.outputs.should_publish == 'true'
              run: |
                  VERSION=$(node -p "require('./package.json').version")
                  git config --local user.email "action@github.com"
                  git config --local user.name "GitHub Action"
                  git tag "v$VERSION"
                  git push origin "v$VERSION"
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            # DXT CLIã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆClaude Desktopæ‹¡å¼µãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ä½œæˆç”¨ï¼‰
            - name: Install DXT CLI
              if: steps.version-check.outputs.should_publish == 'true'
              run: npm install -g @anthropic-ai/dxt

            # DXTãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰
            - name: Build DXT package
              if: steps.version-check.outputs.should_publish == 'true'
              run: |
                  dxt pack
                  VERSION=$(node -p "require('./package.json').version")
                  mv "discord-interface-mcp.dxt" "discord-interface-mcp-${VERSION}.dxt"

            # GitHubãƒªãƒªãƒ¼ã‚¹ã®ä½œæˆï¼ˆDXTãƒ•ã‚¡ã‚¤ãƒ«æ·»ä»˜ï¼‰
            - name: Create GitHub Release
              if: steps.version-check.outputs.should_publish == 'true'
              uses: softprops/action-gh-release@v1
              with:
                  tag_name: v${{ steps.version-check.outputs.version }}
                  name: v${{ steps.version-check.outputs.version }}
                  draft: false
                  prerelease: false
                  files: |
                      discord-interface-mcp-*.dxt
                  body: |
                      ## ğŸš€ Discord Interface MCP v${{ steps.version-check.outputs.version }}

                      ### ğŸ“¦ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•

                      #### One-click ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« (DXT)
                      1. [discord-interface-mcp-${{ steps.version-check.outputs.version }}.dxt](https://github.com/${{ github.repository }}/releases/download/v${{ steps.version-check.outputs.version }}/discord-interface-mcp-${{ steps.version-check.outputs.version }}.dxt) ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                      2. Claude Desktop > Settings > MCP Servers > Add Extension (.dxt)
                      3. ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
                      4. å¿…è¦ãªè¨­å®šã‚’å…¥åŠ›

                      ### ğŸ“ å¤‰æ›´å†…å®¹
                      [å®Œå…¨ãªå¤‰æ›´å±¥æ­´ã‚’è¦‹ã‚‹](https://github.com/${{ github.repository }}/compare/v${{ steps.version-check.outputs.previous_version }}...v${{ steps.version-check.outputs.version }})

                      ---
                      ğŸ¤– Generated with [Claude Code](https://claude.ai/code)
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}